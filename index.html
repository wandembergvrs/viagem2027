<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Viagem de Fam√≠lia 2027 - Marcopolo G8 Dirontur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (mapa interativo) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRrB9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Three.js (simula√ß√£o 3D) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    :root {
      --bg: #f3f4f6;
      --bg-soft: #e5e7eb;
      --card: #ffffff;
      --accent: #facc15;
      --accent-soft: #22c55e;
      --accent-dark: #15803d;
      --text: #0f172a;
      --text-muted: #6b7280;
      --border: #d1d5db;
      --danger: #ea580c;
      --radius-xl: 18px;
      --shadow-soft: 0 12px 24px rgba(15, 23, 42, 0.12);
      --seat-size: 46px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #e5e7eb 0, #f9fafb 45%, #e5e7eb 100%);
      color: var(--text);
      min-height: 100vh;
    }

    a { color: #2563eb; text-decoration: none; font-weight: 600; }
    a:hover { text-decoration: underline; }

    header {
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid rgba(148, 163, 184, 0.45);
      background: linear-gradient(135deg, #facc15 0%, #22c55e 40%, #e5e7eb 85%);
      color: #020617;
    }

    .hero {
      max-width: 900px;
      margin: 0 auto;
      padding: 18px 14px 22px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 16px;
      align-items: center;
    }
    @media (max-width: 768px) { .hero { grid-template-columns: 1fr; } }

    .hero-title {
      font-size: clamp(1.8rem, 4.2vw, 2.4rem);
      font-weight: 800;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .hero-subtitle { font-size: 0.92rem; max-width: 520px; }

    .hero-countdown {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.65);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.86rem;
      color: #020617;
      max-width: 520px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
    }

    .hero-countdown-line {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: baseline;
      justify-content: space-between;
    }

    .hero-countdown-line strong { font-size: 1.2rem; }
    .hero-countdown-sub { font-size: 0.78rem; color: #334155; }

    .hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
      font-size: 0.75rem;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(248, 250, 252, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #1f2937;
    }

    .hero-bus {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
      background: radial-gradient(circle at 20% 0, #eab308 0, #0f172a 40%, #020617 100%);
      min-height: 180px;
    }

    .hero-bus img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
    }

    .hero-bus-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 0, transparent 0%, rgba(15, 23, 42, 0.6) 40%, rgba(15, 23, 42, 0.8) 100%);
    }

    .hero-bus-caption {
      position: absolute;
      left: 12px;
      bottom: 12px;
      background: rgba(15, 23, 42, 0.85);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.72rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .hero-bus-caption strong { color: var(--accent); }

    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 14px 10px 22px;
    }

    section { margin-bottom: 14px; }

    .card {
      background: var(--card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      padding: 12px 12px 10px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -120px;
      background: radial-gradient(circle at 0 0, rgba(250, 204, 21, 0.08), transparent 55%);
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(250, 204, 21, 0.18);
      border: 1px solid rgba(250, 204, 21, 0.5);
      font-size: 0.86rem;
    }

    .card-subtitle {
      font-size: 0.76rem;
      color: var(--text-muted);
      position: relative;
      z-index: 1;
    }

    .pill {
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-soft);
    }
    .pill-dot.warn { background: var(--danger); }

    .stats-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 8px 0;
      font-size: 0.8rem;
      position: relative;
      z-index: 1;
    }

    .stats-row div small {
      display: block;
      color: var(--text-muted);
      font-size: 0.72rem;
      margin-bottom: 1px;
    }

    .stats-row div strong { font-size: 0.86rem; }

    .progress-container { margin-top: 4px; position: relative; z-index: 1; }

    .progress-track {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.75);
      overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(203, 213, 225, 0.5);
      position: relative;
    }

    .progress-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent-soft), var(--accent), #f97316);
      width: 0%;
      transition: width 0.8s ease-out;
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.6);
      position: relative;
    }

    .progress-marker {
      position: absolute;
      top: -2px;
      right: 0;
      transform: translateX(50%);
      width: 4px;
      height: 16px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.85);
      box-shadow: 0 0 10px rgba(148, 163, 184, 0.8);
    }

    .progress-label {
      margin-top: 4px;
      font-size: 0.74rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .progress-label strong { color: var(--accent-dark); font-size: 0.82rem; }

    .info-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 2px;
      font-size: 0.82rem;
      position: relative;
      z-index: 1;
    }

    .info-list li {
      padding: 3px 0;
      display: flex;
      gap: 6px;
      align-items: baseline;
    }

    .info-list li::before {
      content: "‚Ä¢";
      color: var(--accent-soft);
      margin-right: 4px;
      font-size: 0.9rem;
    }

    .info-highlight { margin-top: 3px; font-size: 0.76rem; color: var(--text-muted); }

    .paid-highlight {
      margin-top: 6px;
      font-size: 0.78rem;
      color: #14532d;
      background: #ecfdf3;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(34, 197, 94, 0.6);
      display: none;
      position: relative;
      z-index: 1;
    }

    .passenger-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.76rem;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .passenger-summary span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      color: var(--text-muted);
    }

    .table-wrapper {
      max-height: 340px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      position: relative;
      z-index: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 360px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 2;
      box-shadow: 0 2px 0 rgba(209, 213, 219, 0.9);
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      border-bottom: 1px solid #e5e7eb;
    }

    tbody tr:nth-child(even) { background: #f9fafb; }
    tbody tr:nth-child(odd) { background: #ffffff; }
    tbody tr:hover { background: #eef2ff; }

    td { border-bottom: 1px solid #e5e7eb; color: var(--text); }
    td.status { font-size: 0.76rem; }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .status-pill.paid {
      border-color: rgba(34, 197, 94, 0.7);
      color: #14532d;
      background: #ecfdf3;
    }

    .status-pill.pending {
      border-color: rgba(249, 115, 22, 0.7);
      color: #7c2d12;
      background: #fff7ed;
    }

    .status-pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-soft);
    }
    .status-pill.pending span.dot { background: var(--danger); }

    #trip-map {
      width: 100%;
      height: 260px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      margin-top: 4px;
    }

    /* ===== 3D EXPERIENCE ===== */
    .sim3d-wrap { position: relative; }

    #trip-3d {
      width: 100%;
      height: 360px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      margin-top: 8px;
      background: #0b1220;
    }

    .sim3d-hud {
      position: relative;
      z-index: 2;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.88);
      color: #e5e7eb;
      padding: 10px 10px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.9fr);
      gap: 10px;
      align-items: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.25);
    }

    @media (max-width: 680px) {
      .sim3d-hud { grid-template-columns: 1fr; }
    }

    .sim3d-hud h3 {
      margin: 0 0 4px;
      font-size: 0.92rem;
      letter-spacing: 0.02em;
    }

    .sim3d-hud .line {
      font-size: 0.78rem;
      color: rgba(226, 232, 240, 0.9);
      margin-bottom: 6px;
    }

    .sim3d-hud .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 0.72rem;
    }

    .sim3d-chip {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(2, 6, 23, 0.55);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .sim3d-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }

    .sim3d-dot.warn {
      background: #f97316;
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2);
    }

    .sim3d-progress {
      height: 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.22);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .sim3d-progress > div {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #facc15, #f97316);
      transition: width 180ms linear;
    }

    .sim3d-photo {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(2, 6, 23, 0.55);
      aspect-ratio: 16 / 10;
      display: grid;
      place-items: center;
    }

    .sim3d-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .sim3d-credit {
      margin-top: 6px;
      font-size: 0.66rem;
      color: rgba(226, 232, 240, 0.75);
      line-height: 1.25;
    }

    .sim3d-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      position: relative;
      z-index: 2;
    }

    .sim3d-btn {
      appearance: none;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(248, 250, 252, 0.95);
      color: #0f172a;
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 750;
      font-size: 0.78rem;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
    }

    .sim3d-btn:hover { filter: brightness(0.98); }
    .sim3d-btn:active { transform: translateY(1px); }

    .sim3d-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.76rem;
      color: var(--text-muted);
      background: rgba(248, 250, 252, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
    }

    .sim3d-toggle input { transform: translateY(1px); }

    .sim3d-range {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.76rem;
      color: var(--text-muted);
      background: rgba(248, 250, 252, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
    }

    .sim3d-range input[type="range"] { width: 140px; }

    /* ===== seats ===== */
    .map-note {
      font-size: 0.74rem;
      color: var(--text-muted);
      margin-top: 5px;
      position: relative;
      z-index: 1;
    }

    .seat-controls {
      font-size: 0.76rem;
      margin: 4px 0 8px;
      position: relative;
      z-index: 1;
    }

    .seat-helper { font-size: 0.72rem; color: var(--text-muted); }

    .seat-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .deck {
      padding: 6px 8px 8px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .deck-header {
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .deck-header span { font-weight: 600; color: var(--text); }

    .seat-grid {
      display: grid;
      grid-auto-rows: var(--seat-size);
      gap: 6px;
      justify-content: center;
      margin-top: 2px;
    }

    #seat-grid-upper, #seat-grid-lower { grid-template-columns: repeat(4, var(--seat-size)); }

    .seat, .seat-gap {
      width: var(--seat-size);
      height: var(--seat-size);
    }

    .seat {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: default;
      padding: 3px 2px;
      text-align: center;
      line-height: 1.05;
    }

    .seat.free { background: #f3f4f6; }

    .seat.occupied {
      background: #22c55e;
      color: #022c22;
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.4);
    }

    .seat-number { font-size: 0.62rem; font-weight: 800; opacity: 0.95; }

    .seat-name {
      font-size: 0.62rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .seat-legend {
      margin-top: 6px;
      font-size: 0.72rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .legend-item { display: inline-flex; align-items: center; gap: 4px; }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
    }

    .legend-color.occupied { background: #22c55e; border-color: #16a34a; }

    footer {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 10px 14px;
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
  </style>
</head>

<body>
  <header>
    <div class="hero">
      <div>
        <div class="hero-title">Viagem de Fam√≠lia 2027</div>
        <p class="hero-subtitle">
          Uma viagem tranquila e divertida em fam√≠lia a bordo de um
          <strong>Marcopolo G8 da empresa Dirontur</strong>.
          Veja a foto do √¥nibus
          <a href="dirontur-marcopolo-g8.jpg" target="_blank" rel="noopener noreferrer">
            clicando aqui
          </a>.
        </p>

        <div class="hero-countdown">
          <div class="hero-countdown-line">
            <span>Fam√≠lia! üéâüöç</span>
            <span>
              Faltam <strong id="hero-days-remaining">394</strong> dias para a nossa viagem!
            </span>
          </div>
          <div class="hero-countdown-sub">
            Per√≠odo: <span id="hero-trip-period">08 a 23/01/2027</span>
          </div>
        </div>

        <div class="hero-badges">
          <div class="badge">üöå Marcopolo G8 Dirontur</div>
          <div class="badge">
            üë®‚Äçüë©‚Äçüëß‚Äçüë¶ <span id="hero-badge-people">‚Äì passageiros</span>
          </div>
          <div class="badge">
            üßë Adultos &nbsp;|&nbsp; üßí Crian√ßas &nbsp;|&nbsp; üë∂ Colo
          </div>
        </div>
      </div>

      <div class="hero-bus">
        <img
          src="dirontur-marcopolo-g8.jpg"
          alt="√înibus Marcopolo G8 da empresa Dirontur"
        />
        <div class="hero-bus-overlay"></div>
        <div class="hero-bus-caption">
          <span>üõ£Ô∏è</span>
          <span><strong>Marcopolo G8 Dirontur</strong> ‚Äî estrada, hist√≥rias e boas companhias</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- INFORMA√á√ïES DA VIAGEM -->
    <section class="card" id="trip-info-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">üìå</span>
            Informa√ß√µes da viagem
          </div>
          <p class="card-subtitle">
            Per√≠odo, valor por poltrona, regra das crian√ßas e vis√£o geral.
          </p>
        </div>
      </div>

      <ul class="info-list">
        <li>
          <strong>Per√≠odo:</strong>
          <span id="info-period">08 a 23/01/2027</span>
        </li>
        <li>
          <strong>Valor por pessoa (poltrona):</strong>
          <span id="info-fare">R$ 1.100,00</span>
        </li>
        <li>
          <strong>Parcelamento:</strong>
          at√© <span id="info-installments">10x</span>, com parcelas a partir de
          <span id="info-installment-value">R$ 110,00</span>, come√ßando em dezembro.
        </li>
        <li>
          <strong>Crian√ßas at√© 5 anos:</strong>
          n√£o pagam e v√£o no colo do respons√°vel (sem poltrona marcada).
        </li>
        <li>
          <strong>Resumo:</strong>
          <span id="info-paying-people">‚Äì</span> poltronas pagantes,
          <span id="info-started-people">‚Äì</span> com pagamento iniciado e
          <span id="info-full-people">‚Äì</span> totalmente quitado(s).
        </li>
      </ul>

      <div class="info-highlight">
        As poltronas s√£o definidas na planilha (arquivo <code>passageiros.csv</code>) e apenas exibidas aqui.
      </div>
    </section>

    <!-- PAGAMENTO -->
    <section class="card" id="payment-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">üí≥</span>
            Pagamento da viagem
          </div>
          <p class="card-subtitle">
            Acompanhamento geral das parcelas da fam√≠lia. Nenhum valor individual √© exibido.
          </p>
        </div>
        <div class="pill">
          <span class="pill-dot"></span>
          Vis√£o consolidada da fam√≠lia
        </div>
      </div>

      <div class="stats-row">
        <div>
          <small>Pagamentos iniciados</small>
          <strong id="stats-started-people">0 / 0</strong>
        </div>
        <div>
          <small>Passageiros quitados</small>
          <strong id="stats-full-people">0</strong>
        </div>
        <div>
          <small>Progresso geral pago</small>
          <strong id="stats-percent-small">0%</strong>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-track">
          <div id="payment-progress-fill" class="progress-fill"></div>
          <div class="progress-marker"></div>
        </div>
        <div class="progress-label">
          <span>Percentual das parcelas j√° pagas (sobre o total planejado)</span>
          <strong id="payment-percent-label">0%</strong>
        </div>
        <div class="paid-highlight" id="paid-highlight"></div>
      </div>
    </section>

    <!-- TEMPO -->
    <section class="card" id="time-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">‚è≥</span>
            Contagem para o embarque
          </div>
          <p class="card-subtitle">
            Progresso do tempo entre o in√≠cio do planejamento e o dia da viagem.
          </p>
        </div>
        <div class="pill">
          <span class="pill-dot warn"></span>
          Planejamento em andamento
        </div>
      </div>

      <div class="stats-row">
        <div>
          <small>Datas da viagem</small>
          <strong id="trip-date-label">‚Äì</strong>
        </div>
        <div>
          <small>Dias que faltam</small>
          <strong id="days-remaining-label">‚Äì</strong>
        </div>
        <div>
          <small>Planejamento</small>
          <strong id="planning-window-label">‚Äì</strong>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-track">
          <div id="time-progress-fill" class="progress-fill"></div>
          <div class="progress-marker"></div>
        </div>
        <div class="progress-label">
          <span>Tempo decorrido at√© a viagem</span>
          <strong id="time-percent-label">0%</strong>
        </div>
      </div>
    </section>

    <!-- MAPA DA ROTA -->
    <section class="card" id="map-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">üó∫Ô∏è</span>
            Rota da viagem
          </div>
          <p class="card-subtitle">
            Bras√≠lia ‚Üí Fortaleza ‚Üí Bom Sucesso (PB) ‚Üí Jo√£o Pessoa (PB) ‚Üí Bras√≠lia.
          </p>
        </div>
      </div>

      <div id="trip-map"></div>

      <div class="map-note">
        ‚Ä¢ 08/01/2027 ‚Ä¢ 18h ‚Äî sa√≠da de Bras√≠lia (DF) para Fortaleza (CE)<br />
        ‚Ä¢ 13/01/2027 ‚Äî Fortaleza (CE) ‚Üí Bom Sucesso (PB)<br />
        ‚Ä¢ 17/01/2027 ‚Äî Bom Sucesso (PB) ‚Üí Jo√£o Pessoa (PB)<br />
        ‚Ä¢ 22/01/2027 ‚Äî sa√≠da de Jo√£o Pessoa (PB) para Bras√≠lia (DF)
      </div>
    </section>

    <!-- SIMULA√á√ÉO 3D (COM IMAGENS) -->
    <section class="card" id="sim-3d-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">üß≠</span>
            Simula√ß√£o 3D da rota (com fotos)
          </div>
          <p class="card-subtitle">
            O √¥nibus percorre a rota e o painel mostra imagens das cidades e o progresso do trecho.
          </p>
        </div>
        <div class="pill">
          <span class="pill-dot"></span>
          3D (Three.js)
        </div>
      </div>

      <div class="sim3d-controls">
        <button class="sim3d-btn" id="sim3d-play-btn">‚è∏ Pausar</button>

        <div class="sim3d-range">
          <span>Velocidade</span>
          <input id="sim3d-speed" type="range" min="0.3" max="3" step="0.1" value="1.0" />
          <strong id="sim3d-speed-label">1.0x</strong>
        </div>

        <label class="sim3d-toggle">
          <input id="sim3d-follow" type="checkbox" checked />
          C√¢mera segue o √¥nibus
        </label>
      </div>

      <div class="sim3d-wrap">
        <div class="sim3d-hud" id="sim3d-hud">
          <div>
            <h3 id="sim3d-title">Trecho: ‚Äì</h3>
            <div class="line" id="sim3d-sub">‚Äì</div>

            <div class="chips">
              <div class="sim3d-chip">
                <span class="sim3d-dot" id="sim3d-dot"></span>
                <span id="sim3d-phase">Em rota</span>
              </div>
              <div class="sim3d-chip">
                ‚è±Ô∏è <span id="sim3d-progress-label">0%</span> do trecho
              </div>
            </div>

            <div class="sim3d-progress">
              <div id="sim3d-progress-fill"></div>
            </div>

            <div class="sim3d-credit" id="sim3d-credit">
              Imagens: Wikimedia (cr√©ditos no rodap√©).
            </div>
          </div>

          <div class="sim3d-photo">
            <img id="sim3d-photo" alt="Foto da cidade" src="" loading="lazy" referrerpolicy="no-referrer" />
          </div>
        </div>

        <div id="trip-3d"></div>
      </div>

      <div class="map-note">
        Dica: se a c√¢mera estiver seguindo, voc√™ ainda pode dar zoom; se quiser girar livremente, desmarque ‚ÄúC√¢mera segue o √¥nibus‚Äù.
      </div>
    </section>

    <!-- PASSAGEIROS -->
    <section class="card" id="passengers-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">üßæ</span>
            Lista de passageiros
          </div>
          <p class="card-subtitle">
            Nomes, perfil e situa√ß√£o geral. Parcelas e poltronas s√£o mantidas na planilha
            <code>passageiros.csv</code>.
          </p>
        </div>
      </div>

      <div class="passenger-summary" id="passenger-summary"></div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Passageiro(a)</th>
              <th>Perfil</th>
              <th>Situa√ß√£o</th>
              <th>Parcelas</th>
              <th>Poltrona</th>
            </tr>
          </thead>
          <tbody id="passenger-table-body"></tbody>
        </table>
      </div>
    </section>

    <!-- LAYOUT DE ASSENTOS -->
    <section class="card" id="seat-layout-card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">ü™ë</span>
            Mapa de assentos - Marcopolo G8
          </div>
          <p class="card-subtitle">
            Piso superior: poltronas 1‚Äì48. Piso inferior: 49‚Äì57.
            A ocupa√ß√£o √© apenas informativa, vinda da planilha.
          </p>
        </div>
      </div>

      <div class="seat-controls">
        <span class="seat-helper">
          Mapa ilustrativo das poltronas. Lugares marcados como
          <strong>ocupados</strong> v√™m da coluna de poltronas em
          <code>passageiros.csv</code>. N√£o √© poss√≠vel escolher poltronas pelo site.
        </span>
      </div>

      <div class="seat-layout">
        <div class="deck">
          <div class="deck-header">
            <span>Piso superior</span>
            <span>Poltronas 1‚Äì48</span>
          </div>
          <div class="seat-grid" id="seat-grid-upper"></div>
        </div>

        <div class="deck">
          <div class="deck-header">
            <span>Piso inferior</span>
            <span>Poltronas 49‚Äì57</span>
          </div>
          <div class="seat-grid" id="seat-grid-lower"></div>
        </div>
      </div>

      <div class="seat-legend">
        <div class="legend-item">
          <span class="legend-color"></span>
          Livre
        </div>
        <div class="legend-item">
          <span class="legend-color occupied"></span>
          Ocupado (conforme CSV)
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div>
      Site privado para organizar a viagem da fam√≠lia, mostrando apenas o andamento coletivo.
    </div>
    <div id="footer-credits">
      Cr√©ditos de imagens: Wikimedia Commons / Wikipedia (veja no c√≥digo).
    </div>
  </footer>

  <script>
    // ===============================
    // CONFIGURA√á√ïES
    // ===============================
    const TRIP_START_DATE = new Date("2027-01-08T00:00:00");
    const TRIP_END_DATE = new Date("2027-01-23T00:00:00");
    const PLANNING_START_DATE = new Date("2025-12-09T00:00:00");

    const FARE_PER_PERSON = 1100.0;
    const MAX_INSTALLMENTS = 10;
    const TRIP_TOTAL_VALUE = 59400.0; // apenas para c√°lculo do %

    const msPerDay = 1000 * 60 * 60 * 24;
    const clamp = (n, min, max) => Math.min(Math.max(n, min), max);

    const brCurrency = (value) =>
      value.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

    let passengers = [];

    // ===============================
    // IMAGENS DAS CIDADES (troque aqui se quiser usar arquivos locais)
    // ===============================
    const CITY_MEDIA = {
      bsb: {
        name: "Bras√≠lia (DF)",
        img: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/Catedral_de_Brasilia_01.jpg/1280px-Catedral_de_Brasilia_01.jpg",
        credit: "Bras√≠lia: 'Catedral de Brasilia 01.jpg' (Ag√™ncia Brasil) ‚Äì CC BY 3.0 BR"
      },
      for: {
        name: "Fortaleza (CE)",
        img: "https://upload.wikimedia.org/wikipedia/commons/7/74/Fortaleza%2C_Brazil_%287%29.jpg",
        credit: "Fortaleza: 'Fortaleza, Brazil (7).jpg' (Arthur Fonseca) ‚Äì CC BY 3.0 BR"
      },
      bom: {
        name: "Bom Sucesso (PB)",
        img: "https://upload.wikimedia.org/wikipedia/commons/1/12/Serrinha-Bom_Sucesso.jpg",
        credit: "Bom Sucesso: 'Serrinha-Bom Sucesso.jpg' (AndersonPv) ‚Äì CC BY-SA 4.0"
      },
      jpa: {
        name: "Jo√£o Pessoa (PB)",
        img: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Joao_Pessoa_Paraiba_Farol_do_Cabo_Branco2.jpg/1280px-Joao_Pessoa_Paraiba_Farol_do_Cabo_Branco2.jpg",
        credit: "Jo√£o Pessoa: 'Joao Pessoa Paraiba Farol do Cabo Branco2.jpg' ‚Äì CC BY-SA 2.5"
      }
    };

    // Paradas/rota
    const STOPS = [
      { id: "bsb", coords: [-15.79389, -47.88278] },
      { id: "for", coords: [-3.73186, -38.52667] },
      { id: "bom", coords: [-7.18333, -36.3667] },
      { id: "jpa", coords: [-7.1195, -34.8450] },
    ];

    const SEGMENTS = [
      { from: "bsb", to: "for", date: "08/01/2027 ‚Ä¢ 18h", label: "Bras√≠lia ‚Üí Fortaleza" },
      { from: "for", to: "bom", date: "13/01/2027", label: "Fortaleza ‚Üí Bom Sucesso (PB)" },
      { from: "bom", to: "jpa", date: "17/01/2027", label: "Bom Sucesso (PB) ‚Üí Jo√£o Pessoa (PB)" },
      { from: "jpa", to: "bsb", date: "22/01/2027", label: "Jo√£o Pessoa (PB) ‚Üí Bras√≠lia" },
    ];

    // ===============================
    // PASSAGEIROS (carregados via CSV)
    // ===============================
    async function loadPassengersFromCSV() {
      const response = await fetch("passageiros.csv");
      if (!response.ok) throw new Error("N√£o foi poss√≠vel carregar passageiros.csv");
      const text = await response.text();
      passengers = parsePassengersCSV(text);
    }

    function parsePassengersCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return [];

      const headerLine = lines.shift();
      const delimiter = headerLine.includes(";") ? ";" : ",";
      const headers = headerLine.split(delimiter).map((h) => h.trim().toLowerCase());

      const idxNome = headers.indexOf("nome");
      const idxCategoria = headers.indexOf("categoria");
      const idxParcelas = headers.indexOf("parcelas");
      const idxSeat = headers.findIndex((h) => h === "poltrona" || h === "assento" || h === "seat");

      if (idxNome === -1 || idxCategoria === -1 || idxParcelas === -1) {
        console.error("Cabe√ßalho do passageiros.csv deve ter: Nome;Categoria;Parcelas (e opcionalmente Poltrona/Assento)");
        return [];
      }

      return lines
        .filter((l) => l.trim())
        .map((line) => {
          const cols = line.split(delimiter).map((c) => c.trim());
          const nome = cols[idxNome] || "Sem nome";
          const catCsv = (cols[idxCategoria] || "adulto").toLowerCase();
          const parcelas = Number(cols[idxParcelas] || 0) || 0;

          let category = "adult";
          if (catCsv.startsWith("crianca_colo")) category = "childLap";
          else if (catCsv.startsWith("crianca_poltrona")) category = "childSeat";

          let seat = "";
          if (idxSeat >= 0 && cols[idxSeat]) {
            const n = parseInt(cols[idxSeat], 10);
            if (Number.isFinite(n)) seat = String(n);
          }

          return {
            name: nome,
            category,
            seatType: category === "childLap" ? "Colo" : "Poltrona",
            installmentsPaid: parcelas,
            seat: seat,
          };
        });
    }

    // ===============================
    // AUXILIARES DE PAGAMENTO
    // ===============================
    function getInstallments(p) {
      if (p.seatType === "Colo") return 0;
      const v = Number(p.installmentsPaid);
      if (!Number.isFinite(v) || v < 0) return 0;
      return clamp(v, 0, MAX_INSTALLMENTS);
    }

    const getPayingPassengersCount = () => passengers.filter((p) => p.seatType !== "Colo").length;
    const getStartedPassengersCount = () => passengers.filter((p) => p.seatType !== "Colo" && getInstallments(p) > 0).length;
    const getFullPassengersCount = () => passengers.filter((p) => p.seatType !== "Colo" && getInstallments(p) >= MAX_INSTALLMENTS).length;

    function getTripPaidValue() {
      return passengers.reduce((sum, p) => {
        if (p.seatType === "Colo") return sum;
        const inst = getInstallments(p);
        const share = (inst / MAX_INSTALLMENTS) * FARE_PER_PERSON;
        return sum + share;
      }, 0);
    }

    function getPassengerIcon(p) {
      if (p.category === "childLap") return "üë∂";
      if (p.category === "childSeat") return "üßí";
      return "üßë";
    }

    // ===============================
    // HERO & INFO
    // ===============================
    function updateHero() {
      const heroBadgePeople = document.getElementById("hero-badge-people");
      const heroDays = document.getElementById("hero-days-remaining");
      const heroPeriod = document.getElementById("hero-trip-period");

      const totalPassengers = passengers.length;
      const lapCount = passengers.filter((p) => p.category === "childLap").length;
      const seatCount = totalPassengers - lapCount;

      heroBadgePeople.textContent = `${totalPassengers} passageiros ‚Ä¢ ${seatCount} poltronas + ${lapCount} no colo`;

      const today = new Date();
      const rawRemaining = (TRIP_START_DATE - today) / msPerDay;
      const remainingDays = Math.max(Math.ceil(rawRemaining), 0);
      heroDays.textContent = remainingDays;

      heroPeriod.textContent =
        TRIP_START_DATE.toLocaleDateString("pt-BR") +
        " a " +
        TRIP_END_DATE.toLocaleDateString("pt-BR");
    }

    function updateTripInfoCard() {
      const infoPeriod = document.getElementById("info-period");
      const infoFare = document.getElementById("info-fare");
      const infoInstallments = document.getElementById("info-installments");
      const infoInstallmentValue = document.getElementById("info-installment-value");
      const infoPayingPeople = document.getElementById("info-paying-people");
      const infoStartedPeople = document.getElementById("info-started-people");
      const infoFullPeople = document.getElementById("info-full-people");

      const payingCount = getPayingPassengersCount();
      const startedCount = getStartedPassengersCount();
      const fullCount = getFullPassengersCount();

      infoPeriod.textContent =
        TRIP_START_DATE.toLocaleDateString("pt-BR") +
        " a " +
        TRIP_END_DATE.toLocaleDateString("pt-BR");

      infoFare.textContent = brCurrency(FARE_PER_PERSON);
      infoInstallments.textContent = `${MAX_INSTALLMENTS}x`;
      infoInstallmentValue.textContent = brCurrency(FARE_PER_PERSON / MAX_INSTALLMENTS);

      infoPayingPeople.textContent = `${payingCount}`;
      infoStartedPeople.textContent = `${startedCount}`;
      infoFullPeople.textContent = `${fullCount}`;
    }

    // ===============================
    // PAGAMENTO & TEMPO
    // ===============================
    function updatePaymentPanel() {
      const startedLabel = document.getElementById("stats-started-people");
      const fullLabel = document.getElementById("stats-full-people");
      const smallPercentLabel = document.getElementById("stats-percent-small");
      const progressFill = document.getElementById("payment-progress-fill");
      const percentLabel = document.getElementById("payment-percent-label");
      const paidHighlight = document.getElementById("paid-highlight");

      const payingCount = getPayingPassengersCount();
      const started = getStartedPassengersCount();
      const full = getFullPassengersCount();

      const paidValue = getTripPaidValue();
      const rawPercent = TRIP_TOTAL_VALUE > 0 ? (paidValue / TRIP_TOTAL_VALUE) * 100 : 0;
      const percent = clamp(Math.round(rawPercent), 0, 100);

      startedLabel.textContent = `${started} / ${payingCount}`;
      fullLabel.textContent = `${full}`;
      smallPercentLabel.textContent = percent + "%";
      progressFill.style.width = percent + "%";
      percentLabel.textContent = percent + "%";

      if (paidHighlight) {
        const fullPassengers = passengers.filter((p) => p.seatType !== "Colo" && getInstallments(p) >= MAX_INSTALLMENTS);
        if (fullPassengers.length > 0) {
          paidHighlight.style.display = "block";
          paidHighlight.textContent = "Quitados: " + fullPassengers.map((p) => p.name).join(", ");
        } else {
          paidHighlight.style.display = "none";
          paidHighlight.textContent = "";
        }
      }
    }

    function updateTimePanel() {
      const tripDateLabel = document.getElementById("trip-date-label");
      const daysRemainingLabel = document.getElementById("days-remaining-label");
      const planningWindowLabel = document.getElementById("planning-window-label");
      const timeFill = document.getElementById("time-progress-fill");
      const timePercentLabel = document.getElementById("time-percent-label");

      const today = new Date();

      const totalMs = TRIP_START_DATE - PLANNING_START_DATE;
      const elapsedMs = today - PLANNING_START_DATE;

      const totalDays = totalMs / msPerDay;
      const elapsedDays = clamp(elapsedMs / msPerDay, 0, totalDays);
      const remainingDays = Math.max(Math.ceil((TRIP_START_DATE - today) / msPerDay), 0);

      const percent =
        totalDays > 0
          ? clamp(Math.round((elapsedDays / totalDays) * 100), 0, 100)
          : 0;

      tripDateLabel.textContent =
        TRIP_START_DATE.toLocaleDateString("pt-BR") +
        " a " +
        TRIP_END_DATE.toLocaleDateString("pt-BR");

      daysRemainingLabel.textContent =
        remainingDays === 0 ? "Chegou o grande dia!" : `${remainingDays} ${remainingDays === 1 ? "dia" : "dias"}`;

      planningWindowLabel.textContent =
        PLANNING_START_DATE.toLocaleDateString("pt-BR") +
        " ‚Üí " +
        TRIP_START_DATE.toLocaleDateString("pt-BR");

      timeFill.style.width = percent + "%";
      timePercentLabel.textContent = percent + "%";
    }

    // ===============================
    // TABELA DE PASSAGEIROS
    // ===============================
    function buildPassengerTable() {
      const tbody = document.getElementById("passenger-table-body");
      const summary = document.getElementById("passenger-summary");

      tbody.innerHTML = "";
      summary.innerHTML = "";

      const totalPassengers = passengers.length;
      const totalLap = passengers.filter((p) => p.category === "childLap").length;
      const totalSeatChildren = passengers.filter((p) => p.category === "childSeat").length;
      const totalAdults = passengers.filter((p) => p.category === "adult").length;
      const totalSeats = totalPassengers - totalLap;
      const totalStarted = getStartedPassengersCount();
      const totalFull = getFullPassengersCount();
      const markedSeats = passengers.filter((p) => p.seat && p.seatType !== "Colo").length;

      const pieces = [
        `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${totalPassengers} passageiros`,
        `üßë ${totalAdults} adulto(s)`,
        `üßí ${totalSeatChildren} crian√ßa(s) em poltrona`,
        `üë∂ ${totalLap} crian√ßa(s) no colo`,
        `ü™ë ${totalSeats} poltronas`,
        `‚úÖ ${totalStarted} com pagamento iniciado`,
        `üíØ ${totalFull} totalmente quitado(s)`,
        `üéüÔ∏è ${markedSeats} poltrona(s) marcadas (conforme CSV)`,
      ];

      pieces.forEach((text) => {
        const span = document.createElement("span");
        span.textContent = text;
        summary.appendChild(span);
      });

      passengers.forEach((p, index) => {
        const tr = document.createElement("tr");
        const installments = getInstallments(p);

        const positionTd = document.createElement("td");
        positionTd.textContent = index + 1;

        const nameTd = document.createElement("td");
        const iconSpan = document.createElement("span");
        iconSpan.textContent = getPassengerIcon(p);
        iconSpan.style.marginRight = "4px";
        nameTd.appendChild(iconSpan);
        nameTd.appendChild(document.createTextNode(p.name));

        const typeTd = document.createElement("td");
        let perfilText;
        if (p.category === "childLap") perfilText = "Crian√ßa / Colo";
        else if (p.category === "childSeat") perfilText = "Crian√ßa / Poltrona";
        else perfilText = "Adulto / Poltrona";
        typeTd.textContent = perfilText;

        const statusTd = document.createElement("td");
        statusTd.classList.add("status");
        const statusPill = document.createElement("span");
        statusPill.classList.add("status-pill");
        const dot = document.createElement("span");
        dot.classList.add("dot");
        statusPill.appendChild(dot);

        let statusText;

        if (p.seatType === "Colo") {
          statusPill.classList.add("paid");
          statusText = "Confirmado (colo)";
        } else if (installments > 0) {
          statusPill.classList.add("paid");
          statusText = installments >= MAX_INSTALLMENTS ? "Confirmado (quitado)" : "Confirmado (pagamento iniciado)";
        } else {
          statusPill.classList.add("pending");
          statusText = "Confirmado (pagamento n√£o iniciado)";
        }

        statusPill.appendChild(document.createTextNode(statusText));
        statusTd.appendChild(statusPill);

        const installmentsTd = document.createElement("td");
        installmentsTd.textContent = (p.seatType === "Colo") ? "‚Äì" : `${installments} / ${MAX_INSTALLMENTS}`;

        const seatTd = document.createElement("td");
        if (p.category === "childLap") seatTd.textContent = "No colo (sem poltrona)";
        else if (!p.seat) seatTd.textContent = "N√£o definido na planilha";
        else seatTd.textContent = "Poltrona " + p.seat;

        tr.appendChild(positionTd);
        tr.appendChild(nameTd);
        tr.appendChild(typeTd);
        tr.appendChild(statusTd);
        tr.appendChild(installmentsTd);
        tr.appendChild(seatTd);

        tbody.appendChild(tr);
      });
    }

    // ===============================
    // ASSENTOS (APENAS VISUAL)
    // ===============================
    const upperLayout = [
      [1, 2, 4, 3],
      [5, 6, 8, 7],
      [9, 10, 12, 11],
      [13, 14, null, null],
      [15, 16, null, null],
      [17, 18, 20, 19],
      [21, 22, 24, 23],
      [25, 26, 28, 27],
      [29, 30, 32, 31],
      [33, 34, 36, 35],
      [37, 38, 40, 39],
      [41, 42, 44, 43],
      [45, 46, 48, 47],
    ];

    const lowerLayout = [
      [49, 50, null, 51],
      [52, 53, null, 54],
      [55, 56, null, 57],
    ];

    function getFirstName(fullName) {
      const s = String(fullName || "").trim();
      if (!s) return "";
      return s.split(/\s+/)[0];
    }

    function findPassengerBySeat(seatNumber) {
      const sn = String(seatNumber);
      return passengers.find((p) => p.seat && String(p.seat) === sn && p.seatType !== "Colo");
    }

    function createSeatElement(seatNumber) {
      const seatEl = document.createElement("div");
      seatEl.className = "seat";
      seatEl.dataset.number = seatNumber;

      const passenger = findPassengerBySeat(seatNumber);

      const numEl = document.createElement("div");
      numEl.className = "seat-number";
      numEl.textContent = seatNumber;
      seatEl.appendChild(numEl);

      if (passenger) {
        seatEl.classList.add("occupied");
        seatEl.title = "Ocupado por " + passenger.name;

        const nameEl = document.createElement("div");
        nameEl.className = "seat-name";
        nameEl.textContent = getFirstName(passenger.name);
        seatEl.appendChild(nameEl);
      } else {
        seatEl.classList.add("free");
        seatEl.title = "Livre";
      }

      return seatEl;
    }

    function buildUpperDeck() {
      const container = document.getElementById("seat-grid-upper");
      if (!container) return;
      container.innerHTML = "";
      upperLayout.forEach((row) => {
        row.forEach((cell) => {
          if (cell == null) {
            const gap = document.createElement("div");
            gap.className = "seat-gap";
            container.appendChild(gap);
          } else {
            container.appendChild(createSeatElement(cell));
          }
        });
      });
    }

    function buildLowerDeck() {
      const container = document.getElementById("seat-grid-lower");
      if (!container) return;
      container.innerHTML = "";
      lowerLayout.forEach((row) => {
        row.forEach((cell) => {
          if (cell == null) {
            const gap = document.createElement("div");
            gap.className = "seat-gap";
            container.appendChild(gap);
          } else {
            container.appendChild(createSeatElement(cell));
          }
        });
      });
    }

    function buildSeatLayout() { buildUpperDeck(); buildLowerDeck(); }

    // ===============================
    // MAPA DA ROTA (Leaflet) + fotos no popup
    // ===============================
    function initMap() {
      const mapElement = document.getElementById("trip-map");
      if (!mapElement || typeof L === "undefined") return;

      const map = L.map("trip-map", { scrollWheelZoom: false }).setView([-10, -40], 4.5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const stopById = {};
      const latlngsAll = [];

      STOPS.forEach((stop) => {
        stopById[stop.id] = stop;
        const media = CITY_MEDIA[stop.id];

        const marker = L.circleMarker(stop.coords, {
          radius: 6,
          weight: 2,
          color: "#f97316",
          fillColor: "#facc15",
          fillOpacity: 0.9,
        }).addTo(map);

        const imgHtml = media?.img
          ? `<img src="${media.img}" alt="${media.name}" style="width:100%;max-width:220px;border-radius:10px;margin-top:6px;border:1px solid #e5e7eb" loading="lazy" referrerpolicy="no-referrer"/>`
          : "";

        marker.bindPopup(`<strong>${media?.name || stop.id}</strong><br/>${imgHtml}`);

        latlngsAll.push(stop.coords);
      });

      SEGMENTS.forEach((seg, idx) => {
        const from = stopById[seg.from];
        const to = stopById[seg.to];
        if (!from || !to) return;

        const polyline = L.polyline([from.coords, to.coords], {
          weight: 4,
          color: idx % 2 === 0 ? "#22c55e" : "#0ea5e9",
          opacity: 0.9,
        }).addTo(map);

        polyline.bindPopup(`<strong>${seg.label}</strong><br>${seg.date}`);
      });

      map.fitBounds(latlngsAll, { padding: [16, 16] });
    }

    // ===============================
    // SIMULA√á√ÉO 3D (Three.js) ‚Äî com fotos
    // ===============================
    const sim3d = {
      playing: true,
      speedMult: 1.0,
      followCamera: true
    };

    function createTextTexture(text, w = 1024, h = 640) {
      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");

      ctx.fillStyle = "#0b1220";
      ctx.fillRect(0, 0, w, h);

      // moldura
      ctx.strokeStyle = "rgba(250,204,21,0.9)";
      ctx.lineWidth = 10;
      ctx.strokeRect(18, 18, w - 36, h - 36);

      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = "bold 64px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(text, w / 2, h / 2);

      const tex = new THREE.CanvasTexture(canvas);
      if (THREE.SRGBColorSpace) tex.colorSpace = THREE.SRGBColorSpace;
      return tex;
    }

    function estimateTForPoint(curve, target, samples = 2000) {
      let bestT = 0;
      let bestD = Infinity;
      for (let i = 0; i <= samples; i++) {
        const t = i / samples;
        const p = curve.getPointAt(t);
        const d = p.distanceToSquared(target);
        if (d < bestD) {
          bestD = d;
          bestT = t;
        }
      }
      return bestT;
    }

    function init3DSim() {
      const el = document.getElementById("trip-3d");
      if (!el) return;

      // limpa execu√ß√µes anteriores
      if (el._trip3dRAF) cancelAnimationFrame(el._trip3dRAF);
      if (el._trip3dRO) el._trip3dRO.disconnect();
      if (el._trip3dOnResize) window.removeEventListener("resize", el._trip3dOnResize);

      // HUD refs
      const hudTitle = document.getElementById("sim3d-title");
      const hudSub = document.getElementById("sim3d-sub");
      const hudPhoto = document.getElementById("sim3d-photo");
      const hudCredit = document.getElementById("sim3d-credit");
      const hudDot = document.getElementById("sim3d-dot");
      const hudPhase = document.getElementById("sim3d-phase");
      const hudProgressLabel = document.getElementById("sim3d-progress-label");
      const hudProgressFill = document.getElementById("sim3d-progress-fill");

      try {
        if (typeof THREE === "undefined") throw new Error("Three.js n√£o carregou (THREE indefinido).");

        // Controles UI
        const playBtn = document.getElementById("sim3d-play-btn");
        const speedRange = document.getElementById("sim3d-speed");
        const speedLabel = document.getElementById("sim3d-speed-label");
        const followCheck = document.getElementById("sim3d-follow");

        if (playBtn) {
          playBtn.onclick = () => {
            sim3d.playing = !sim3d.playing;
            playBtn.textContent = sim3d.playing ? "‚è∏ Pausar" : "‚ñ∂Ô∏è Continuar";
          };
        }
        if (speedRange && speedLabel) {
          const applySpeed = () => {
            sim3d.speedMult = Number(speedRange.value) || 1.0;
            speedLabel.textContent = sim3d.speedMult.toFixed(1) + "x";
          };
          speedRange.oninput = applySpeed;
          applySpeed();
        }
        if (followCheck) {
          followCheck.onchange = () => { sim3d.followCamera = !!followCheck.checked; };
          sim3d.followCamera = !!followCheck.checked;
        }

        // rota (fecha loop voltando a Bras√≠lia)
        const routeLatLon = [
          STOPS[0].coords, // bsb
          STOPS[1].coords, // for
          STOPS[2].coords, // bom
          STOPS[3].coords, // jpa
          STOPS[0].coords  // bsb (volta)
        ];

        // convers√£o lat/lon -> plano
        const lats = routeLatLon.map(p => p[0]);
        const lons = routeLatLon.map(p => p[1]);
        const lat0 = (Math.min(...lats) + Math.max(...lats)) / 2;
        const lon0 = (Math.min(...lons) + Math.max(...lons)) / 2;

        const kmPerDegLat = 111.32;
        const kmPerDegLon = 111.32 * Math.cos((lat0 * Math.PI) / 180);
        const scale = 0.06; // 1 km -> 0.06 unidades

        const toVec3 = ([lat, lon]) => {
          const xKm = (lon - lon0) * kmPerDegLon;
          const zKm = (lat - lat0) * kmPerDegLat;
          return new THREE.Vector3(xKm * scale, 0, -zKm * scale);
        };

        const points = routeLatLon.map(toVec3);

        // cena
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0b1220);

        // renderer
        const rect = el.getBoundingClientRect();
        const w = Math.max(1, Math.floor(rect.width));
        const h = Math.max(1, Math.floor(rect.height));

        const camera = new THREE.PerspectiveCamera(55, w / h, 0.1, 5000);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(w, h);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
        if (renderer.outputColorSpace && THREE.SRGBColorSpace) renderer.outputColorSpace = THREE.SRGBColorSpace;

        el.innerHTML = "";
        el.appendChild(renderer.domElement);
        renderer.domElement.style.display = "block";

        // orbit controls (opcional)
        const Orbit = THREE.OrbitControls || window.OrbitControls;
        const controls = Orbit ? new Orbit(camera, renderer.domElement) : null;
        if (controls) {
          controls.enableDamping = true;
          controls.dampingFactor = 0.08;
        }

        // luz
        scene.add(new THREE.AmbientLight(0xffffff, 0.75));
        const dir = new THREE.DirectionalLight(0xffffff, 0.9);
        dir.position.set(80, 120, 60);
        scene.add(dir);

        // curva e linha
        const curve = new THREE.CatmullRomCurve3(points, false, "catmullrom", 0.15);
        const routeGeom = new THREE.BufferGeometry().setFromPoints(curve.getPoints(420));
        const routeMat = new THREE.LineBasicMaterial({ color: 0x22c55e, transparent: true, opacity: 0.95 });
        scene.add(new THREE.Line(routeGeom, routeMat));

        // stops (esferas)
        const stopGeom = new THREE.SphereGeometry(1.45, 18, 18);
        const stopMat = new THREE.MeshStandardMaterial({ color: 0xfacc15, roughness: 0.35, metalness: 0.1 });

        // sprites (pain√©is com fotos)
        const loader = new THREE.TextureLoader();
        if (loader.setCrossOrigin) loader.setCrossOrigin("anonymous");

        function addPhotoSprite(stopId, pos) {
          const media = CITY_MEDIA[stopId];
          const fallbackTex = createTextTexture(media?.name || stopId);

          const mat = new THREE.SpriteMaterial({ map: fallbackTex, transparent: true });
          const sprite = new THREE.Sprite(mat);

          // escala inicial 16:10
          sprite.scale.set(18, 11.25, 1);
          sprite.position.copy(pos);
          sprite.position.y = 12;

          scene.add(sprite);

          if (media?.img) {
            loader.load(
              media.img,
              (tex) => {
                if (THREE.SRGBColorSpace) tex.colorSpace = THREE.SRGBColorSpace;
                mat.map = tex;
                mat.needsUpdate = true;

                // ajusta escala pela propor√ß√£o real
                const iw = tex.image?.width || 16;
                const ih = tex.image?.height || 10;
                const aspect = iw / ih;
                const baseH = 11.25;
                sprite.scale.set(baseH * aspect, baseH, 1);
              },
              undefined,
              () => {
                // mant√©m fallback de texto
              }
            );
          }

          return sprite;
        }

        // coloca as esferas e sprites nas 4 paradas (sem repetir a √∫ltima Bras√≠lia)
        const stopIds = ["bsb", "for", "bom", "jpa"];
        const stopPositions = points.slice(0, 4);

        stopPositions.forEach((p, i) => {
          const m = new THREE.Mesh(stopGeom, stopMat);
          m.position.copy(p);
          m.position.y = 1.45;
          scene.add(m);

          addPhotoSprite(stopIds[i], p);
        });

        // √¥nibus
        const bus = new THREE.Mesh(
          new THREE.BoxGeometry(3.2, 1.6, 6.0),
          new THREE.MeshStandardMaterial({ color: 0xf97316, roughness: 0.35, metalness: 0.1 })
        );
        bus.position.copy(points[0]);
        bus.position.y = 1.2;
        scene.add(bus);

        // auto-fit camera na rota
        const box = new THREE.Box3().setFromPoints(points);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);

        const fov = (camera.fov * Math.PI) / 180;
        const fitDist = (maxDim / 2) / Math.tan(fov / 2);
        const dist = fitDist * 1.25;

        camera.near = Math.max(0.1, dist / 200);
        camera.far = dist * 20;
        camera.updateProjectionMatrix();
        camera.position.set(center.x + dist, center.y + dist * 0.55, center.z + dist);
        camera.lookAt(center);

        if (controls) {
          controls.target.copy(center);
          controls.update();
        }

        // grid
        const gridSize = Math.max(80, maxDim * 2.2);
        const grid = new THREE.GridHelper(gridSize, 22, 0xffffff, 0xffffff);
        grid.material.opacity = 0.12;
        grid.material.transparent = true;
        scene.add(grid);

        // t dos stops (para dividir trechos)
        const tFor = estimateTForPoint(curve, points[1]);
        const tBom = estimateTForPoint(curve, points[2]);
        const tJpa = estimateTForPoint(curve, points[3]);
        const stopTs = [0, tFor, tBom, tJpa, 1];

        // HUD helper
        function setHud(segmentIndex, segProgress) {
          const seg = SEGMENTS[segmentIndex];
          const from = CITY_MEDIA[seg.from];
          const to = CITY_MEDIA[seg.to];

          const pct = clamp(Math.round(segProgress * 100), 0, 100);
          const phase = (segProgress >= 0.92) ? `Chegando em ${to?.name || seg.to}` :
                        (segProgress <= 0.08) ? `Saindo de ${from?.name || seg.from}` :
                        "Em rota";

          if (hudTitle) hudTitle.textContent = `Trecho: ${seg.label}`;
          if (hudSub) hudSub.textContent = `${seg.date} ‚Ä¢ Pr√≥ximo destino: ${to?.name || seg.to}`;
          if (hudPhase) hudPhase.textContent = phase;
          if (hudProgressLabel) hudProgressLabel.textContent = `${pct}%`;
          if (hudProgressFill) hudProgressFill.style.width = pct + "%";

          if (hudDot) {
            hudDot.classList.toggle("warn", segProgress >= 0.92);
          }

          if (hudPhoto && to?.img && hudPhoto.src !== to.img) {
            hudPhoto.src = to.img;
          }

          if (hudCredit) {
            // mostra cr√©dito do destino (to)
            hudCredit.textContent = to?.credit ? `Foto do destino: ${to.credit}` : "Foto do destino: ‚Äì";
          }
        }

        // inicializa HUD no primeiro trecho
        setHud(0, 0);

        // anima√ß√£o
        let t = 0;
        const baseSpeed = 0.001; // base (antes do multiplicador)

        function animate() {
          // avance do tempo
          if (sim3d.playing) {
            t = (t + baseSpeed * sim3d.speedMult) % 1;
          }

          // posi√ß√£o do √¥nibus
          const pos = curve.getPointAt(t);
          const tan = curve.getTangentAt(t);

          bus.position.set(pos.x, 1.2, pos.z);

          // orienta o √¥nibus
          const yaw = Math.atan2(tan.x, tan.z);
          bus.rotation.set(0, yaw, 0);

          // segmento atual
          let segIdx = 0;
          for (let i = 0; i < stopTs.length - 1; i++) {
            if (t >= stopTs[i] && t <= stopTs[i + 1]) { segIdx = i; break; }
          }
          const segStart = stopTs[segIdx];
          const segEnd = stopTs[segIdx + 1];
          const segProgress = (segEnd > segStart) ? (t - segStart) / (segEnd - segStart) : 0;

          setHud(segIdx, segProgress);

          // c√¢mera seguindo o √¥nibus
          if (controls) {
            if (sim3d.followCamera) {
              controls.target.lerp(bus.position, 0.12);
              // mant√©m a c√¢mera mais ‚Äúde cima e atr√°s‚Äù
              const behind = tan.clone().multiplyScalar(-35);
              const up = new THREE.Vector3(0, 18, 0);
              const desired = bus.position.clone().add(behind).add(up);
              camera.position.lerp(desired, 0.06);
              camera.lookAt(controls.target);
              controls.update();
            } else {
              controls.update();
            }
          }

          renderer.render(scene, camera);
          el._trip3dRAF = requestAnimationFrame(animate);
        }
        animate();

        // resize robusto
        const onResize = () => {
          const r = el.getBoundingClientRect();
          const nw = Math.max(1, Math.floor(r.width));
          const nh = Math.max(1, Math.floor(r.height));
          camera.aspect = nw / nh;
          camera.updateProjectionMatrix();
          renderer.setSize(nw, nh);
        };
        el._trip3dOnResize = onResize;
        window.addEventListener("resize", onResize);

        const ro = new ResizeObserver(onResize);
        ro.observe(el);
        el._trip3dRO = ro;

        // footer credits
        const footerCredits = document.getElementById("footer-credits");
        if (footerCredits) {
          footerCredits.textContent =
            "Cr√©ditos de imagens: " +
            [CITY_MEDIA.bsb.credit, CITY_MEDIA.for.credit, CITY_MEDIA.bom.credit, CITY_MEDIA.jpa.credit].join(" ‚Ä¢ ");
        }

      } catch (e) {
        console.error("Erro no 3D:", e);
        el.innerHTML = `
          <div style="padding:12px;color:#e5e7eb;font-size:0.85rem;line-height:1.35">
            <strong>Erro ao iniciar o 3D.</strong><br/>
            ${String(e && e.message ? e.message : e)}<br/>
            Abra o Console (F12) para ver detalhes.
          </div>
        `;
      }
    }

    // ===============================
    // INICIALIZA√á√ÉO
    // ===============================
    function initAfterPassengersLoaded() {
      updateHero();
      updateTripInfoCard();
      updatePaymentPanel();
      updateTimePanel();
      buildPassengerTable();
      buildSeatLayout();
      initMap();
      init3DSim();
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadPassengersFromCSV()
        .then(() => initAfterPassengersLoaded())
        .catch((err) => {
          console.warn(
            "Erro ao carregar passageiros.csv; verifique se o arquivo est√° na mesma pasta (e sirva via HTTP).",
            err
          );
          passengers = [];
          initAfterPassengersLoaded();
        });
    });
  </script>
</body>
</html>
